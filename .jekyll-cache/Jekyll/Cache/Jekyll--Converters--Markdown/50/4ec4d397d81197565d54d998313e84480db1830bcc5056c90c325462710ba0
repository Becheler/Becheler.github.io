I"e<p>Quetzal is mainly designed to simulate discrete populations in a discrete space.
Of course you can still manually define a couple of populations with no spatial structure
like in <a href="tuto_demography.md">this tutorial</a>. You could add to these populations a
<em>certain form</em> of spatial structure when defining
the migration rates between them. This can work for a reasonable number of populations.</p>

<p>However, <strong>a large number of populations is cumbersome to define and to manipulate.</strong></p>

<p>And you certainly consider to <strong>define some model quantities as functions of the environment</strong>.</p>

<p>So what you actually need is:</p>
<ul>
  <li>tools that ease the definition/manipulation of a high number of populations.</li>
  <li>to read some data files containing the relevant environmental information</li>
  <li>an easy way to retrieve and to manipulate the environmental information across the simulation.</li>
</ul>

<p>Quetzal features were designed to answer these needs.</p>

<h2 id="download-geographic-datasets">Download geographic datasets</h2>

<p>First you will need a geographic dataset to read. <a href="http://worldclim.org/version2">Go to worldclim</a>
and download the 10-minutes average temperature. We will focus here on the January month data file.</p>

<blockquote>
  <p><strong>Important:</strong> Quetzal does not aim to be another GIS software. It aims at easing
your life concerning spatial coalescence softwares. For this reason, it supports only
GeoTiff files that meet the worldclim standard. Contact us if you have any trouble.</p>
</blockquote>

<blockquote>
  <p>GeoTiff is a public standard that allows to describe cartographic information,
like map projection coordinate systems, ellipsoids, datum, that is associated to
TIFF pictures like satellite imagery, elevation maps, climate data…</p>
</blockquote>

<h2 id="prepare-your-script">Prepare your script</h2>

<p>So open a new text file, give it a nice name like <code class="language-plaintext highlighter-rouge">tuto_geo.cpp</code> and let’s write
some code!</p>

<p>First you need to include the <code class="language-plaintext highlighter-rouge">geography</code> module and the STL input/output support
before to declare the main function where we will write our code:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "path_to_quetzal_directory/quetzal/geography.h"
#include &lt;string&gt;
#include &lt;iostream&gt;
</span>
<span class="kt">int</span> <span class="n">main</span>
<span class="p">{</span>
  <span class="c1">// write things here</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="read-an-environmental-quantity">Read an environmental quantity</h2>

<h3 id="about-the-temporal-dimension">About the temporal dimension</h3>

<p>In Quetzal geographic classes, the temporal dimension is represented by the depth
of the dataset. That is, when we have $t$ layers in the GeoTiff file, the first layer
represents the oldest data, and the last layer the most recent data.</p>

<p>The dataset we uploaded from worldclim has only one layer of data,
because it represents “present” quantities for each month, averaged over 1970-2000.</p>

<blockquote>
  <p><strong>Note:</strong> If you want to concatenate these 12 months-data to build a 12-layers deep dataset
that could represent a year, do it using another software. The raster package in R will
be perfectly suited.</p>
</blockquote>

<p>So we can represent this singular time-point by anything (an integer, a hash …) but for sake of clarity,
we will here use a simple string and name the time-point <code class="language-plaintext highlighter-rouge">january_present</code>
We use a type aliases to make this choice clear:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">time_type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="construct-your-spatial-object">Construct your spatial object</h3>

<p>Then we want to use a Quetzal tool that allows to represent this geospatial data.
We can use the <code class="language-plaintext highlighter-rouge">EnvironmentalQuantity</code> class. It takes as a template parameter
the type you want to use to represent the temporal dimension (that is, in this example,
  a <code class="language-plaintext highlighter-rouge">std::string</code>, or equivalently a <code class="language-plaintext highlighter-rouge">time_type</code>). Let’s make things clear:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">quantity_type</span> <span class="o">=</span> <span class="n">quetzal</span><span class="o">::</span><span class="n">geography</span><span class="o">::</span><span class="n">EnvironmentalQuantity</span><span class="o">&lt;</span><span class="n">time_type</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span> <span class="n">coord_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">quantity_type</span><span class="o">::</span><span class="n">coord_type</span><span class="p">;</span>
</code></pre></div></div>
<p>The second line automatically retrieves the type used in Quetzal to represent
geographic coordinates and assign a new type alias. This type
encapsulates a lot a troubles, like projection system, great circle distance computation…</p>

<p>After these definitions, you can finally build your quantity, giving to the constructor</p>
<ul>
  <li>the path to the data</li>
  <li>a vector of ordered time points for each layer, from the oldest to the most recent</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">quantity_type</span> <span class="nf">my_quantity</span><span class="p">(</span> <span class="s">"my_file"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">time_type</span><span class="o">&gt;</span><span class="p">{</span><span class="s">"january_present"</span><span class="p">}</span> <span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong> here we use only one point time. In another setting, you would probably
want to write things like this:</p>
  <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">quantity_type</span> <span class="nf">my_quantity</span><span class="p">(</span> <span class="s">"my_file"</span><span class="p">,</span> <span class="p">{</span><span class="mi">2001</span><span class="p">,</span><span class="mi">2002</span><span class="p">,</span><span class="mi">2003</span><span class="p">,</span><span class="mi">2004</span><span class="p">,</span><span class="mi">2005</span><span class="p">,</span><span class="mi">2006</span><span class="p">,</span><span class="mi">2007</span><span class="p">,</span><span class="mi">2008</span><span class="p">,</span><span class="mi">2009</span><span class="p">,</span><span class="mi">2010</span><span class="p">}</span> <span class="p">);</span>
</code></pre></div>  </div>
</blockquote>

<h3 id="retrieve-the-set-of-inhabitable-demes">Retrieve the set of inhabitable demes</h3>

<p>When considering a spatial grid, it is quite usual to consider that each cell
of the grid is a deme. So to represent each deme with a unique identifier,
we can use the centroids of each cell.</p>

<blockquote>
  <p><strong>Note</strong>: we could use the raw/column indices of the spatial grid as indices
of the demes, but doing so we would be putting too much emphasis on the grid
representation and loosing the geographic intuition. Emphasizing details is
typically what should be avoided in software design.</p>
</blockquote>

<p>Moreover, we are generally interested in representing only demes that are inhabitable.
Typically we do not want to pay for representing ocean cells in the simulation context.
In worldclim datasets, oceans environmental values are undefined, so to get the continental
demes we have to retrieve only the centroids of the cells for which the environmental data is defined.</p>

<p>This is exactly the purpose of the <code class="language-plaintext highlighter-rouge">geographic_definition_space</code> function:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">space</span> <span class="o">=</span> <span class="n">my_quantity</span><span class="p">.</span><span class="n">geographic_definition_space</span><span class="p">();</span>
</code></pre></div></div>

<p>We can iterate over this geographic space. The following lines prints out the
geographic coordinates of the continental demes:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">it</span> <span class="o">:</span> <span class="n">space</span><span class="p">){</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">it</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Importantly, this collection of inhabitable demes is typically what you need to
<a href="tuto_dispersal.md">construct dispersal models</a> for spatially-explicit simulations.</p>

<p>Similarly, you can retrieve at any time the time steps related to the dataset
and iterate over it:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">times</span> <span class="o">=</span> <span class="n">my_quantity</span><span class="p">.</span><span class="n">temporal_definition_space</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">it</span> <span class="o">:</span> <span class="n">times</span><span class="p">){</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">it</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="read-the-data-inside">Read the data inside</h3>

<p>To retrieve the quantity value at deme $x$ at time $t$,
use the following function by passing the right arguments:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">:</span> <span class="n">times</span><span class="p">){</span>
  <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">x</span> <span class="o">:</span> <span class="n">space</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">my_quantity</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>An that’s it !</p>

<h3 id="complete-script-and-compilation">Complete script and compilation</h3>

<p>The complete script is given below. Make sure gou give the right paths
on your own system.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "my_path/quetzal/geography.h"
#include &lt;iostream&gt;
#include &lt;assert.h&gt;
#include &lt;string&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

	<span class="k">using</span> <span class="n">time_type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
	<span class="k">using</span> <span class="n">quantity_type</span> <span class="o">=</span> <span class="n">quetzal</span><span class="o">::</span><span class="n">geography</span><span class="o">::</span><span class="n">EnvironmentalQuantity</span><span class="o">&lt;</span><span class="n">time_type</span><span class="o">&gt;</span><span class="p">;</span>
	<span class="k">using</span> <span class="n">coord_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">quantity_type</span><span class="o">::</span><span class="n">coord_type</span><span class="p">;</span>

	<span class="n">quantity_type</span> <span class="n">my_quantity</span><span class="p">(</span> <span class="s">"my_file.tif"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">time_type</span><span class="o">&gt;</span><span class="p">{</span><span class="s">"january_present"</span><span class="p">}</span> <span class="p">);</span>

	<span class="k">auto</span> <span class="n">times</span> <span class="o">=</span> <span class="n">my_quantity</span><span class="p">.</span><span class="n">temporal_definition_space</span><span class="p">();</span>
	<span class="k">auto</span> <span class="n">space</span> <span class="o">=</span> <span class="n">my_quantity</span><span class="p">.</span><span class="n">geographic_definition_space</span><span class="p">();</span>

	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Demic structure for demographic simulation"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">it</span> <span class="o">:</span> <span class="n">space</span><span class="p">)</span>
  <span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">it</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">:</span> <span class="n">times</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">x</span> <span class="o">:</span> <span class="n">space</span><span class="p">){</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">my_quantity</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When you compile it, make sure that you link to the <a href="getting_started#install-gdal">gdal library</a> :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g++ -Wall -std=c++14 tuto_geo.cpp -I/usr/include/gdal  -L/usr/lib/ -lgdal
</code></pre></div></div>

<p>Then run the script with <code class="language-plaintext highlighter-rouge">./a.out</code></p>

<h2 id="constructing-a-multi-variate-environment">Constructing a multi-variate environment</h2>

<p>The joint manipulation of multiple environmental dataset can be tricky: the system has to
guarantee a common geographic subset for which all environmental quantities are defined,
that the temporal ranges of each variable are consistent, that resolutions are identical
across files…</p>

<p>Using multiple EnvironmentalQuantity objects is error-prone, and you should
prefer instead the use of the DiscreteLandscape classm that secures the construction
of a multivariate, temporal, spatial grid.</p>

<p>Most of the concepts are similar to those previously exposed so just read the following code
as an illustration.</p>

<p>Some precisions however:</p>
<ul>
  <li>You have to give identifiers to the quantities, so you can retrieve them later. These
identifiers can be of any user-defined type: integers, strings …</li>
  <li>The quantities retrieved from a DiscreteLandscape have the semantic of a function
of space and time.</li>
  <li>If you want to run the following script, make sure that your TIFF files are consistent with the
temporal range given in the demonstration code.</li>
  <li>Reprojecting <code class="language-plaintext highlighter-rouge">coord_type</code> objects to the nearest cell centroid is a precious feature when
incorporating genetic dataset in the spatial analysis, because it allows you to easily
reproject your sample in the demic structure.</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "my_path/quetzal/geography.h"
#include &lt;iostream&gt;   // std::cout
#include &lt;string&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span><span class="n">bio12</span>
<span class="p">{</span>
  <span class="k">using</span> <span class="n">ID_type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
	<span class="k">using</span> <span class="n">time_type</span> <span class="o">=</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">;</span>
	<span class="k">using</span> <span class="n">landscape_type</span> <span class="o">=</span> <span class="n">quetzal</span><span class="o">::</span><span class="n">geography</span><span class="o">::</span><span class="n">DiscreteLandscape</span><span class="o">&lt;</span><span class="n">ID_type</span><span class="p">,</span> <span class="n">time_type</span><span class="o">&gt;</span><span class="p">;</span>
	<span class="n">landscape_type</span> <span class="n">env</span><span class="p">(</span> <span class="p">{</span> <span class="p">{</span><span class="s">"rain"</span><span class="p">,</span><span class="s">"my_file.tif"</span><span class="p">},</span>
                        <span class="p">{</span><span class="s">"temperature"</span><span class="p">,</span><span class="s">"other_file.tif"</span><span class="p">}</span>
                      <span class="p">},</span>
	                    <span class="p">{</span><span class="mi">2001</span><span class="p">,</span><span class="mi">2002</span><span class="p">,</span><span class="mi">2003</span><span class="p">,</span><span class="mi">2004</span><span class="p">,</span><span class="mi">2005</span><span class="p">,</span><span class="mi">2006</span><span class="p">,</span><span class="mi">2007</span><span class="p">,</span><span class="mi">2008</span><span class="p">,</span><span class="mi">2009</span><span class="p">,</span><span class="mi">2010</span><span class="p">}</span> <span class="p">);</span>

	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">env</span><span class="p">.</span><span class="n">quantities_nbr</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" quantities read from files"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

  <span class="n">landscape_type</span><span class="o">::</span><span class="n">coord_type</span> <span class="n">Bordeaux</span><span class="p">(</span><span class="mf">44.5</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">is_in_spatial_extent</span><span class="p">(</span><span class="n">Bordeaux</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Centroid: "</span> <span class="o">&lt;&lt;</span> <span class="n">env</span><span class="p">.</span><span class="n">reproject_to_centroid</span><span class="p">(</span><span class="n">Bordeaux</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Retrieve environmental functions</span>
  <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s">"rain"</span><span class="p">];</span>
  <span class="k">auto</span> <span class="n">g</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s">"temperature"</span><span class="p">];</span>

  <span class="k">auto</span> <span class="n">times</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">temporal_definition_space</span><span class="p">();</span>
  <span class="k">auto</span> <span class="n">space</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">geographic_definition_space</span><span class="p">();</span>

  <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">:</span> <span class="n">times</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">x</span> <span class="o">:</span> <span class="n">space</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">200.</span> <span class="o">&amp;&amp;</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">600.</span><span class="p">){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\t</span><span class="s">"</span> <span class="o">&lt;&lt;</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
:ET